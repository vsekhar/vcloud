#!/bin/bash

# import credentials and functions
. CREDENTIALS
. nohosts

if [ $# -eq 0 ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
	echo 'usage: inject pkg_file.tar.bz2'
	exit 2
fi

package_file=$1
[ ! -f './.reservation' ] && { echo 'No .reservation file found'; exit 1; }
reservation_id=`cat ./.reservation`
[ ! $package_file ] || [ ! -f $package_file ] && { echo "Package file not found: $package_file"; exit 1; }

# wait until all instances are in "running" status
while true; do
	instances=`ec2-describe-instances --filter reservation-id=$reservation_id | grep ^INSTANCE`
	statuses=`echo "${instances}" | cut -f6`
	finished=1
	for status in $statuses; do
		[ "$status" != "running" ] && finished=0
	done
	[ $finished -eq 1 ] && break
done

# inject into each host the seeds file & package contents, and launch
hostnames=`echo "${instances}" | cut -f4`
for hostname in $hostnames; do
	seeds=`echo $hostnames | tr ' ' '\n' | grep -v $hostname | sed "s/\$/:$initial_listen_port/"`
	
	remote_cmd=`cat <<EOF
		sudo bash -c "mkdir -p /var/vcloud; echo ${seeds} | tr ' ' '\n' > /var/vcloud/seeds";
		cat > remote_tarball;
		tar jxf remote_tarball;
		cd ${remote_pkg_dir};
		screen -d -m ./main
EOF` # end delimeter has to start at col 0

	cat $package_file | sshnh $login_user@$hostname $remote_cmd
done
